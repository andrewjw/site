---
layout: post
title: Back Garden Weather in CouchDB (Part 1)
date: 2011-12-02 12:00:55.000000000 +00:00
tags:
- couchdb
- pywws
- weather
permalink: "/2011/12/02/back-garden-weather-in-couchdb-part-1/"
flickr_user: 'https://www.flickr.com/photos/allthestarsthatshine/'
flickr_username: "ShyViolet09"
flickr_image: 'https://live.staticflickr.com/3698/10132686826_3444b62474_w.jpg'
flickr_imagelink: 'https://www.flickr.com/photos/allthestarsthatshine/10132686826/'
flickr_imagename: 'Rain'
---
When she was younger my wife wanted to be a meteorologist. That didn't pan out, but our recent move found us
with a garden, which we've not had before. This gave me the opportunity to buy her 
[a weather station](http://smartweather.co.uk/product.php?productid=16144&amp;cat=249&amp;page=1). I
didn't just choose any old station though, I wanted one that did wind and rain as well as the usual
temperature, pressure and humidity. And, the deciding factor, a USB interface with Linux support. Fortunately
the excellent [PyWWS](http://code.google.com/p/pywws/) supports a range of weather stations,
including the one I brought.

I'm not going to go into how I [mounted the
system](http://www.flickr.com/photos/andrew_j_w/6246463884/), or configured PyWWS. That's all covered in the documentation. PyWWS can produce a static website,
but as someone who earns his living building websites I wanted something a bit better. 
[Continuing](http://wp.me/pkxET-6z) my experiments with CouchDB I decided to build the website as a 
[CouchApp](http://couchapp.org/).

As well as allowing you to query your data with Javascript, CouchDB lets you display webpages directly out of
your database. If you visit [welwynweather.co.uk](http://www.welwynweather.co.uk) you'll notice
that you're redirected to a url that contains url arguments that look a lot like those used to 
[query a view](http://wiki.apache.org/couchdb/HTTP_view_API#Access.2BAC8-Query). That's because that's
exactly what's going on. Things become clearer when you discover that that 
[http://www.welwynweather.co.uk](http://www.welwynweather.co.uk) is an alias for 
[http://db.welwynweather.co.uk/_design/weather/_rewrite/](http://db.welwynweather.co.uk/_design/weather/_rewrite/).
Now you can see a more complete CouchDB URL, albeit without the database name. 
[db.welwynweather.co.uk](http://db.welwynweather.co.uk/) points to an Apache reverse proxy that routes
requests through to CouchDB.

Over the next few posts I'll detail how the CouchApp works, but to get started you can clone my app and poke
it yourself. Once you've installed the `couchapp` command line client simply run `couchapp clone
http://db.welwynweather.co.uk/_design/weather`. This will give you a directory, `weather`, that
contains a number of subdirectories including `templates` and `views` which contain the complete
website.n To deploy the site to your own server you need to create a database and then run `couchapp push
weather http://localhost:5984/welwynweather`. Visiting
`http://localhost:5984/welwynweather/_design/weather/_rewrite/` should show you the site. You'll need
some data though, and you can use CouchDB replication to pull my data to your server. Using Futon simply set
`http://db.welwynweather.co.uk/` as the replication source and your database as the destination and
you'll quickly get a complete copy of the database.

When replicating my data you currently cannot use continuous replication. When it completes replication
CouchDB calls `POST /_ensure_full_commit`, but obviously I've disabled `POST`, `PUT` and
`DELETE` on my server. This causes replication to fail and to restart from the beginning. The data will
already have been copied, but CouchDB will copy it again. If you have any ideas on how to avoid this, please
answer my [StackOverflow question](http://stackoverflow.com/q/8309521/2990).

The website consists of four main pages. When you visit you are redirected to a page that shows the weather
for the current day. Clicking on the date at the top of the page lets you also view the weather by month and
by year. The daily weather pages show as much detail as is recorded by the station, in my case this is an
update every five minutes. The monthly page is much the same except that the values are averaged across an
hour. The yearly page is a bit different as it shows a single point for each day. An average temperature for
each day is not that useful so we calculate the high and low for each day and display that.

The final page is the records page. This displays information like the highest and lowest temperature ever
recorded and the heaviest rain by hour and by day. The previous three pages are all fully generated by the
server. The records page is a bit different though as calculating the records in one step is a bit
complicated, instead we use AJAX to load each record individually. This means we can focus on each record
keeping the code simple.

In the next post I'll discuss how I import data into CouchDB and the basics of rendering a page in a CouchApp.

<hr />

If you visit the site you may find that there is no recent weather data. This is because I run PyWWS on my 
[MythTV](http://www.mythtv.org) box. Rather than running the PC all the time the weather data only
updates when a programme is being recorded, or I'm watching TV.
